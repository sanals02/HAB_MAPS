<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>خريطة حفر الباطن عالية الدقة</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
 
  <!-- Leaflet -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
 
  <style>
    html, body {
      height: 100%;
      margin: 0;
      background: #000;
      font-family: "TheSansArabic", sans-serif;
    }
    #map {
      height: 100%;
      width: 100%;
    }
    .leaflet-popup-content {
      text-align: center;
      direction: rtl;
      font-size: 14px;
    }
  </style>
</head>
 
<body>
  <div id="map"></div>
 
  <script>
    // === Initialize map centered on Hafar Al-Batin ===
    const map = L.map("map", {
      center: [28.4322, 45.9708],
      zoom: 13,
      minZoom: 10,
      maxZoom: 22,
      zoomControl: true,
    });
 
    // === ESRI World Imagery (High-Resolution Satellite) ===
    const esriSatellite = L.tileLayer(
      "https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",
      {
        maxZoom: 22,
        attribution: "© Esri, Maxar, Earthstar Geographics",
      }
    ).addTo(map);
 
    // === ESRI Label Layer ===
    const esriLabels = L.tileLayer(
      "https://server.arcgisonline.com/ArcGIS/rest/services/Reference/World_Boundaries_and_Places/MapServer/tile/{z}/{y}/{x}",
      {
        maxZoom: 22,
        opacity: 1,
        attribution: "© Esri",
      }
    ).addTo(map);
 
    // === Marker handling ===
    let markers = [];
    let markersMap = {}; // Map region names to markers
    let selectedMarker = null;

    // === Helper function to reset all markers to red ===
    function resetAllMarkers() {
      markers.forEach((m) => {
        m.setStyle({
          color: "#ff0000",
          fillColor: "#ff0000",
          radius: 8,
        });
      });
      selectedMarker = null;
    }

    // === Helper function to highlight a specific marker ===
    function highlightMarkerByName(regionName) {
      console.log("🟡 Attempting to highlight region:", regionName);
      
      // Reset all first
      resetAllMarkers();
      
      // Try exact match first
      let marker = markersMap[regionName];
      
      // If not found, try decoded version
      if (!marker) {
        const decoded = decodeURIComponent(regionName);
        marker = markersMap[decoded];
        console.log("Trying decoded:", decoded);
      }
      
      // If still not found, try encoded version
      if (!marker) {
        const encoded = encodeURIComponent(regionName);
        marker = markersMap[encoded];
        console.log("Trying encoded:", encoded);
      }
      
      if (marker) {
        console.log("✅ Found marker for:", regionName);
        marker.setStyle({
          color: "#ffff00",
          fillColor: "#ffff00",
          radius: 11,
        });
        selectedMarker = marker;
        
        // Pan to the marker
        map.panTo(marker.getLatLng());
      } else {
        console.warn("⚠️ No marker found for:", regionName);
        console.log("Available markers:", Object.keys(markersMap));
      }
    }
 
    // --- Receive data from Grafana ---
    window.addEventListener("message", (event) => {
      const { type, data, region } = event.data || {};
      
      console.log("📩 Received message type:", type);

      // === Handle habData (initial data load) ===
      if (type === "habData") {
        console.log("📍 Loading region data...", data);
        
        // Clear existing markers
        markers.forEach((m) => map.removeLayer(m));
        markers = [];
        markersMap = {};
        selectedMarker = null;
 
        const regionData = data || [];
        if (!regionData.length) return;
 
        regionData.forEach((r) => {
          const regionName = decodeURIComponent(r.name);
          
          const marker = L.circleMarker([r.lat, r.long], {
            radius: 8,
            color: "#ff0000",
            fillColor: "#ff0000",
            fillOpacity: 0.9,
            weight: 1.5,
          })
            .addTo(map)
            .bindPopup(`<b>${regionName}</b>`)
            .on("click", () => {
              console.log("🖱️ Marker clicked:", regionName);
              
              // Reset previous
              if (selectedMarker && selectedMarker !== marker) {
                selectedMarker.setStyle({
                  color: "#ff0000",
                  fillColor: "#ff0000",
                  radius: 8,
                });
              }
 
              // Highlight current
              marker.setStyle({
                color: "#ffff00",
                fillColor: "#ffff00",
                radius: 11,
              });
              selectedMarker = marker;
 
              // Send region to Grafana (send decoded name)
              console.log("📤 Sending to Grafana:", regionName);
              window.parent.postMessage(
                {
                  type: "mapClick",
                  region: encodeURIComponent(regionName), // Send encoded
                },
                "*"
              );
            });
 
          markers.push(marker);
          markersMap[regionName] = marker; // Store decoded name as key
        });
 
        if (regionData.length > 1) {
          const bounds = L.latLngBounds(regionData.map((r) => [r.lat, r.long]));
          map.fitBounds(bounds, { padding: [40, 40] });
        }
        
        console.log("✅ Loaded markers for regions:", Object.keys(markersMap));
      }
      
      // === Handle highlightRegion (dropdown selection) ===
      else if (type === "highlightRegion") {
        console.log("🎯 Highlight request for:", region);
        
        if (region) {
          highlightMarkerByName(region);
        }
      }
    });
  </script>
</body>
</html>
